// prisma/schema.prisma
// LogiProfit - Sistema de Rentabilidad para Empresas de Fletes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENTIDADES CORE ====================

model Empresa {
  id        Int      @id @default(autoincrement())
  nombre    String
  rfc       String?  @unique
  plan      Plan     @default(BASICO)
  activa    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  usuarios             Usuario[]
  clientes             Cliente[]
  camiones             Camion[]
  choferes             Chofer[]
  cotizaciones         Cotizacion[]
  fletes               Flete[]
  configuracionesMapeo ConfiguracionMapeo[]
  importacionesLog     ImportacionLog[]
  plantillasGasto      PlantillaGasto[]

  @@map("empresas")
}

enum Plan {
  BASICO
  PROFESIONAL
  ENTERPRISE
}

model Usuario {
  id        Int         @id @default(autoincrement())
  empresaId Int
  nombre    String
  email     String      @unique
  password  String
  rol       RolUsuario
  activo    Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  empresa                     Empresa                   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  permisos                    UsuarioPermiso[]
  solicitudesCombustible      SolicitudCombustible[]    @relation("SolicitudesOperador")
  solicitudesViatico          SolicitudViatico[]        @relation("SolicitudViaticoOperador")
  comprobacionesViatico       ComprobacionViatico[]     @relation("ComprobacionViaticoOperador")
  comprobacionesViaticoValidadas ComprobacionViatico[] @relation("ComprobacionViaticoValidador")

  @@index([empresaId])
  @@index([email])
  @@map("usuarios")
}

enum RolUsuario {
  ADMIN
  OPERADOR
  CHOFER
  CONTABILIDAD
  DIRECCION
}

// ==================== PERMISOS RBAC ====================

model Permiso {
  id          Int              @id @default(autoincrement())
  modulo      String           // "cotizaciones", "fletes", "reportes", etc.
  accion      String           // "crear", "leer", "actualizar", "eliminar", "exportar"
  descripcion String
  createdAt   DateTime         @default(now())

  usuarios    UsuarioPermiso[]

  @@unique([modulo, accion])
  @@map("permisos")
}

model UsuarioPermiso {
  id         Int      @id @default(autoincrement())
  usuarioId  Int
  permisoId  Int
  createdAt  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, permisoId])
  @@map("usuario_permisos")
}

model Cliente {
  id        Int      @id @default(autoincrement())
  empresaId Int
  nombre    String
  rfc       String?
  email     String?
  telefono  String?
  direccion String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa      Empresa      @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cotizaciones Cotizacion[]
  fletes       Flete[]

  @@map("clientes")
}

// ==================== COTIZACIONES ====================

model Cotizacion {
  id               Int              @id @default(autoincrement())
  empresaId        Int
  clienteId        Int
  folio            String           @unique
  origen           String
  destino          String

  // Descripción de la carga
  tipoCarga        String?
  pesoCarga        Decimal?         @db.Decimal(10, 2) // toneladas
  dimensiones      String?          // "L x A x H"

  // Kilometraje estimado
  kmEstimado       Decimal          @default(0) @db.Decimal(10, 2)

  // Precio cotizado al cliente (único monto que ve el cliente)
  precioCotizado   Decimal          @db.Decimal(12, 2)

  // Estado y datos administrativos
  estado           EstadoCotizacion @default(BORRADOR)
  notas            String?
  validoHasta      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  empresa   Empresa             @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente   Cliente             @relation(fields: [clienteId], references: [id])
  fletes    Flete[]
  conceptos CotizacionConcepto[]

  @@index([empresaId, estado])
  @@index([clienteId])
  @@index([createdAt])
  @@map("cotizaciones")
}

// Conceptos/Servicios de la cotización (líneas personalizables)
model CotizacionConcepto {
  id           Int        @id @default(autoincrement())
  cotizacionId Int
  tipo         TipoGasto? // Para comparar con gastos reales
  descripcion  String     // Ej: "Diesel", "Casetas", "Maniobras", etc.
  cantidad     Decimal    @db.Decimal(10, 2)
  unidad       String     // Ej: "litros", "km", "servicio", "día"
  precioUnit   Decimal    @db.Decimal(12, 2)
  subtotal     Decimal    @db.Decimal(12, 2) // cantidad * precioUnit
  orden        Int        @default(0) // Para ordenar los conceptos
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  cotizacion Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)

  @@index([cotizacionId])
  @@map("cotizacion_conceptos")
}

enum EstadoCotizacion {
  BORRADOR
  ENVIADA
  APROBADA
  RECHAZADA
  CONVERTIDA
  CANCELADA
}

// ==================== FLETES ====================

model Flete {
  id            Int         @id @default(autoincrement())
  empresaId     Int
  cotizacionId  Int?
  clienteId     Int
  folio         String      @unique

  origen        String
  destino       String
  kmReales      Decimal?    @db.Decimal(10, 2)

  precioCliente Decimal     @db.Decimal(12, 2)
  estado        EstadoFlete @default(PLANEADO)

  fechaInicio   DateTime?
  fechaFin      DateTime?

  // Campos de pago
  estadoPago      EstadoPago? @default(PENDIENTE)
  montoPagado     Decimal?    @db.Decimal(12, 2) @default(0)
  fechaVencimiento DateTime?
  fechaPago       DateTime?

  notas         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  empresa      Empresa            @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cotizacion   Cotizacion?        @relation(fields: [cotizacionId], references: [id], onDelete: Restrict)
  cliente      Cliente            @relation(fields: [clienteId], references: [id])
  camiones     FleteCamion[]
  choferes     FleteChofer[]
  gastos              Gasto[]
  checklist           FleteChecklist[]
  factura             Factura?
  solicitudesCombustible SolicitudCombustible[]
  solicitudesViatico     SolicitudViatico[]
  comprobacionesViatico  ComprobacionViatico[]

  @@index([empresaId, estado])
  @@index([empresaId, estadoPago])
  @@index([clienteId])
  @@index([fechaInicio])
  @@index([fechaVencimiento])
  @@index([createdAt])
  @@map("fletes")
}

model FleteChecklist {
  id          Int      @id @default(autoincrement())
  fleteId     Int
  descripcion String
  completado  Boolean  @default(false)
  orden       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  flete Flete @relation(fields: [fleteId], references: [id], onDelete: Cascade)

  @@index([fleteId])
  @@map("flete_checklist")
}

enum EstadoFlete {
  PLANEADO
  EN_CURSO
  COMPLETADO
  CERRADO
  CANCELADO
}

enum EstadoPago {
  PENDIENTE
  PARCIAL
  PAGADO
  VENCIDO
}

// ==================== CAMIONES ====================

model Camion {
  id                    Int      @id @default(autoincrement())
  empresaId             Int
  placas                String
  numeroEconomico       String?
  marca                 String?
  modelo                String?
  anio                  Int?
  tipo                  TipoCamion
  rendimientoKmLCargado Decimal  @default(2.5) @db.Decimal(5, 2) // km por litro cargado
  rendimientoKmLVacio   Decimal  @default(3.0) @db.Decimal(5, 2) // km por litro vacío
  capacidadCarga        Decimal? @db.Decimal(10, 2) // toneladas
  kmActual              Decimal  @default(0) @db.Decimal(10, 2) // odómetro actual
  activo                Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  empresa        Empresa             @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  fletes         FleteCamion[]
  gastos         Gasto[]
  mantenimientos Mantenimiento[]
  documentos     DocumentoVehiculo[]

  @@unique([empresaId, placas])
  @@map("camiones")
}

enum TipoCamion {
  TORTON
  TRAILER
  RABON
  CAMIONETA
  LOWBOY      // Cama baja para cargas sobredimensionadas
  OTRO
}

// ==================== CHOFERES ====================

model Chofer {
  id        Int         @id @default(autoincrement())
  empresaId Int
  nombre    String
  telefono  String?
  licencia  String?
  tipo      TipoChofer
  tipoPago  TipoPago
  tarifa    Decimal     @db.Decimal(10, 2)
  activo    Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  empresa Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  fletes  FleteChofer[]

  @@map("choferes")
}

enum TipoChofer {
  FIJO
  ROTATIVO
}

enum TipoPago {
  POR_DIA
  POR_VIAJE
  POR_KM
  POR_QUINCENA
  MENSUAL
  MENSUAL_DETALLADO
}

// ==================== ASIGNACIONES ====================

model FleteCamion {
  id        Int      @id @default(autoincrement())
  fleteId   Int
  camionId  Int
  principal Boolean  @default(false)
  notas     String?
  createdAt DateTime @default(now())

  flete  Flete  @relation(fields: [fleteId], references: [id], onDelete: Cascade)
  camion Camion @relation(fields: [camionId], references: [id])

  @@unique([fleteId, camionId])
  @@map("flete_camiones")
}

model FleteChofer {
  id               Int      @id @default(autoincrement())
  fleteId          Int
  choferId         Int
  fechaInicio      DateTime
  fechaFin         DateTime?
  dias             Int?
  kmReales         Decimal? @db.Decimal(10, 2)
  salarioCalculado Decimal? @db.Decimal(12, 2)
  notas            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  flete  Flete  @relation(fields: [fleteId], references: [id], onDelete: Cascade)
  chofer Chofer @relation(fields: [choferId], references: [id])

  @@map("flete_choferes")
}

// ==================== GASTOS ====================

model CategoriaGasto {
  id            Int      @id @default(autoincrement())
  empresaId     Int
  nombre        String
  descripcion   String?
  color         String?  // Hex color para UI
  activa        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  gastos        Gasto[]
  presupuestos  PresupuestoCategoria[]

  @@map("categorias_gasto")
}

model PlantillaGasto {
  id             Int       @id @default(autoincrement())
  empresaId      Int
  nombre         String
  tipo           TipoGasto
  concepto       String?
  montoEstimado  Decimal   @db.Decimal(12, 2)
  activa         Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@map("plantillas_gasto")
}

model Gasto {
  id                 Int              @id @default(autoincrement())
  fleteId            Int
  camionId           Int?
  categoriaId        Int?
  solicitudViaticoId Int?             // Vínculo opcional con solicitud de viático
  tipo               TipoGasto
  concepto           String?
  monto              Decimal          @db.Decimal(12, 2)
  fecha              DateTime
  comprobanteUrl     String?
  validado           Boolean          @default(false)
  validadoPor        Int?
  validadoAt         DateTime?
  notas              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  flete            Flete             @relation(fields: [fleteId], references: [id], onDelete: Cascade)
  camion           Camion?           @relation(fields: [camionId], references: [id])
  categoria        CategoriaGasto?   @relation(fields: [categoriaId], references: [id])
  solicitudViatico SolicitudViatico? @relation(fields: [solicitudViaticoId], references: [id], onDelete: SetNull)

  @@index([fleteId])
  @@index([categoriaId])
  @@index([solicitudViaticoId])
  @@index([fecha])
  @@map("gastos")
}

enum TipoGasto {
  DIESEL
  CASETAS
  VIATICOS
  MANTENIMIENTO
  MULTA
  SALARIO
  PENSION
  MANIOBRAS
  OTRO
}

// ==================== PRESUPUESTOS ====================

model Presupuesto {
  id          Int      @id @default(autoincrement())
  empresaId   Int
  nombre      String
  periodo     String   // "2024-01", "2024-Q1", "2024"
  total       Decimal  @db.Decimal(12, 2)
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categorias  PresupuestoCategoria[]

  @@map("presupuestos")
}

model PresupuestoCategoria {
  id             Int            @id @default(autoincrement())
  presupuestoId  Int
  categoriaId    Int
  monto          Decimal        @db.Decimal(12, 2)
  createdAt      DateTime       @default(now())

  presupuesto    Presupuesto    @relation(fields: [presupuestoId], references: [id], onDelete: Cascade)
  categoria      CategoriaGasto @relation(fields: [categoriaId], references: [id])

  @@unique([presupuestoId, categoriaId])
  @@map("presupuesto_categorias")
}

// ==================== MANTENIMIENTO ====================

model Mantenimiento {
  id                Int                  @id @default(autoincrement())
  camionId          Int
  tipo              TipoMantenimiento
  descripcion       String
  kmProgramado      Decimal?             @db.Decimal(10, 2)
  fechaProgramada   DateTime?
  kmRealizado       Decimal?             @db.Decimal(10, 2)
  fechaRealizado    DateTime?
  costo             Decimal?             @db.Decimal(12, 2)
  proveedor         String?
  comprobanteUrl    String?
  estado            EstadoMantenimiento  @default(PENDIENTE)
  notas             String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  camion Camion @relation(fields: [camionId], references: [id], onDelete: Cascade)

  @@index([camionId, estado])
  @@index([fechaProgramada])
  @@map("mantenimientos")
}

enum TipoMantenimiento {
  PREVENTIVO
  CORRECTIVO
  CAMBIO_ACEITE
  CAMBIO_LLANTAS
  FRENOS
  SUSPENSION
  ELECTRICO
  TRANSMISION
  MOTOR
  OTRO
}

enum EstadoMantenimiento {
  PENDIENTE
  EN_PROCESO
  COMPLETADO
  CANCELADO
}

// ==================== DOCUMENTOS DE VEHÍCULOS ====================

model DocumentoVehiculo {
  id               Int             @id @default(autoincrement())
  camionId         Int
  tipo             TipoDocumento
  numero           String?
  archivoUrl       String          // URL del archivo en storage
  nombreArchivo    String          // Nombre original del archivo
  fechaEmision     DateTime
  fechaVencimiento DateTime
  estado           EstadoDocumento @default(VIGENTE)
  notas            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  camion Camion @relation(fields: [camionId], references: [id], onDelete: Cascade)

  @@index([camionId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@map("documentos_vehiculo")
}

enum TipoDocumento {
  POLIZA
  TARJETA_CIRCULACION
  VERIFICACION
  LICENCIA
  TARJETA_IAVE
  PERMISO_SCT
  SEGURO
  OTRO
}

enum EstadoDocumento {
  VIGENTE
  POR_VENCER    // Menos de 30 días para vencimiento
  VENCIDO
}

// ==================== FACTURACIÓN ====================

model Factura {
  id               Int               @id @default(autoincrement())
  fleteId          Int               @unique
  numero           String            // Número de factura
  serie            String?
  uuid             String            @unique // UUID fiscal (Timbre)
  fechaEmision     DateTime
  fechaVencimiento DateTime?

  // Montos
  subtotal         Decimal           @db.Decimal(12, 2)
  iva              Decimal           @db.Decimal(12, 2)
  total            Decimal           @db.Decimal(12, 2)

  // Datos fiscales
  metodoPago       MetodoPago?       @default(PUE)
  formaPago        FormaPago?        @default(TRANSFERENCIA)
  usoCFDI          String?           // G03, P01, etc.

  // Archivos
  xmlUrl           String?           // URL del archivo XML
  pdfUrl           String?           // URL del archivo PDF

  // Estado
  estadoPago       EstadoPagoFactura @default(PENDIENTE)

  // Notas y metadatos
  notas            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  flete            Flete             @relation(fields: [fleteId], references: [id], onDelete: Restrict)

  @@index([estadoPago])
  @@index([fechaEmision])
  @@index([fechaVencimiento])
  @@map("facturas")
}

enum MetodoPago {
  PUE  // Pago en una sola exhibición
  PPD  // Pago en parcialidades o diferido
}

enum FormaPago {
  EFECTIVO          // 01
  CHEQUE            // 02
  TRANSFERENCIA     // 03
  TARJETA_CREDITO   // 04
  TARJETA_DEBITO    // 28
  POR_DEFINIR       // 99
}

enum EstadoPagoFactura {
  PENDIENTE
  PAGADA_PARCIAL
  PAGADA
  VENCIDA
  CANCELADA
}

// ==================== SOLICITUDES DE COMBUSTIBLE ====================

model SolicitudCombustible {
  id          Int              @id @default(autoincrement())
  fleteId     Int
  operadorId  Int
  estado      EstadoSolicitud  @default(PENDIENTE)
  montoTotal  Decimal          @db.Decimal(12, 2)

  // Aprobación y depósito
  aprobadoPor    Int?
  aprobadoAt     DateTime?
  depositadoPor  Int?
  depositadoAt   DateTime?
  rechazadoPor   Int?
  rechazadoAt    DateTime?
  motivoRechazo  String?

  notas       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  flete    Flete              @relation(fields: [fleteId], references: [id], onDelete: Cascade)
  operador Usuario            @relation("SolicitudesOperador", fields: [operadorId], references: [id])
  paradas  SolicitudParada[]

  @@index([fleteId])
  @@index([operadorId])
  @@index([estado])
  @@map("solicitudes_combustible")
}

model SolicitudParada {
  id           Int      @id @default(autoincrement())
  solicitudId  Int
  orden        Int      @default(0) // Orden de la parada
  lugar        String   // "Gasolinera X, Ciudad Y"
  litros       Decimal  @db.Decimal(10, 2)
  precioLitro  Decimal  @db.Decimal(10, 2)
  total        Decimal  @db.Decimal(12, 2) // litros * precioLitro
  notas        String?
  createdAt    DateTime @default(now())

  solicitud SolicitudCombustible @relation(fields: [solicitudId], references: [id], onDelete: Cascade)

  @@index([solicitudId])
  @@map("solicitud_paradas")
}

enum EstadoSolicitud {
  PENDIENTE
  APROBADA
  RECHAZADA
  DEPOSITADA
}

// ==================== INTEGRACIONES EXTERNAS ====================

model ConfiguracionMapeo {
  id              Int             @id @default(autoincrement())
  empresaId       Int
  nombre          String
  descripcion     String?
  sistema         SistemaExterno
  tipoArchivo     TipoArchivo
  activa          Boolean         @default(true)
  mapeos          Json            // { "folio": "COL_A", "clienteNombre": "COL_B", ... }
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  empresa         Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  importaciones   ImportacionLog[]

  @@index([empresaId])
  @@map("configuraciones_mapeo")
}

model ImportacionLog {
  id                      Int                  @id @default(autoincrement())
  empresaId               Int
  usuarioId               Int?
  configuracionMapeoId    Int?
  nombreArchivo           String
  tipoOperacion           TipoOperacion
  formato                 TipoArchivo
  totalRegistros          Int
  registrosExitosos       Int
  registrosActualizados   Int
  registrosErrores        Int
  detallesErrores         Json?
  createdAt               DateTime             @default(now())

  empresa                 Empresa              @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  configuracionMapeo      ConfiguracionMapeo?  @relation(fields: [configuracionMapeoId], references: [id])

  @@index([empresaId])
  @@index([createdAt])
  @@map("importaciones_log")
}

enum SistemaExterno {
  ASPEL
  MICROSIP
  OTRO
}

enum TipoArchivo {
  EXCEL
  CSV
  XML
}

enum TipoOperacion {
  IMPORTACION
  EXPORTACION
}

// ==================== VIÁTICOS ====================

model SolicitudViatico {
  id                    Int                      @id @default(autoincrement())
  fleteId               Int
  operadorId            Int
  tipoGasto             TipoGastoViatico
  periodoInicio         DateTime
  periodoFin            DateTime
  montoSolicitado       Decimal                  @db.Decimal(12, 2)
  detalle               Json                     // Array de {concepto: string, importe: number}
  estado                EstadoSolicitudViatico   @default(SOLICITADO)
  pdfUrl                String?
  comprobanteDepositoUrl String?                 // Comprobante del depósito (foto o PDF)
  enviadoAdmon          Boolean                  @default(false)
  correoEnvioTs         DateTime?
  aprobadoPor           Int?
  aprobadoAt            DateTime?
  depositadoPor         Int?
  depositadoAt          DateTime?
  canceladoPor          Int?
  canceladoAt           DateTime?
  motivoCancelacion     String?
  notas                 String?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  flete                 Flete                    @relation(fields: [fleteId], references: [id], onDelete: Cascade)
  operador              Usuario                  @relation("SolicitudViaticoOperador", fields: [operadorId], references: [id])
  comprobaciones        ComprobacionViatico[]
  gastos                Gasto[]                  // Gastos vinculados a este viático

  @@index([fleteId])
  @@index([operadorId])
  @@index([estado])
  @@map("solicitudes_viatico")
}

model ComprobacionViatico {
  id                Int                         @id @default(autoincrement())
  solicitudId       Int?
  fleteId           Int
  operadorId        Int
  archivos          Json                        // Array de {tipo: 'TICKET'|'CFDI_PDF'|'CFDI_XML', archivoUrl: string, monto: number, fechaGasto: Date, nota?: string}
  estado            EstadoComprobacionViatico   @default(PENDIENTE_VALIDACION)
  validadorId       Int?
  validadoAt        DateTime?
  motivoRechazo     String?
  notas             String?
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt

  solicitud         SolicitudViatico?           @relation(fields: [solicitudId], references: [id])
  flete             Flete                       @relation(fields: [fleteId], references: [id], onDelete: Cascade)
  operador          Usuario                     @relation("ComprobacionViaticoOperador", fields: [operadorId], references: [id])
  validador         Usuario?                    @relation("ComprobacionViaticoValidador", fields: [validadorId], references: [id])

  @@index([solicitudId])
  @@index([fleteId])
  @@index([operadorId])
  @@index([estado])
  @@map("comprobaciones_viatico")
}

enum TipoGastoViatico {
  ALIMENTOS
  HOSPEDAJE
  CASETAS
  COMBUSTIBLE
  OTROS
}

enum EstadoSolicitudViatico {
  SOLICITADO
  APROBADO
  DEPOSITADO
  CANCELADO
}

enum EstadoComprobacionViatico {
  PENDIENTE_VALIDACION
  APROBADO
  RECHAZADO
}
